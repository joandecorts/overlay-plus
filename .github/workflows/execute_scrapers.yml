name: Executar Scrapers i Actualitzar Dades

on:
  # 1. DISPARAT DES DE CRON-JOB.ORG (EXTERN)
  repository_dispatch:
    types: [trigger_scrapers]
  # 2. EXECUCIÓ MANUAL (GITHUB UI)
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Obtenir el codi
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Configurar Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3. Instal·lar dependències
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pandas openpyxl

      # 4. EXECUTAR ELS TEUS SCRAPERS I GENERADORS
      - name: Run meteo.cat scrapers and generators
        run: |
          echo "=== INICIANT PROCÉS ==="
          
          echo "Executant SCRAPER PRINCIPAL (executor_meteo.py) amb respostes automàtiques..."
          echo -e "1\n1\ns\n" | python executor_meteo.py
          
          echo "Executant generador de banners..."
          python generador_banners.py
          echo "=== PROCÉS FINALITZAT ==="

      # 5. PUJAR CANVIS AL REPOSITORI
      - name: Commit and push all updates
        env:
          # Utilitza el token d'acció de GitHub, més segur
          GH_TOKEN: ${{ secrets.Auto_Cron_Job_Token }}
        run: |
          # A. Configurar l'usuari per al commit
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          
          # B. Afegir tots els canvis
          git add --all
          
          # C. Crear commit (ignora si no hi ha canvis)
          git commit -m "Update automàtic: dades i banners [$(date -u +'%Y-%m-%d %H:%M')]" || echo "No hi ha canvis per cometre"
          
          # D. Fer push (amb GITHUB_TOKEN)
          git push "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/joandecorts/overlay-plus"
