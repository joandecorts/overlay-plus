name: Executar Scrapers i Actualitzar Dades

on:
  # 1. CRON EXTERN (VIA cron-job.org)
  repository_dispatch:
    types: [trigger_scrapers]
  
  # 2. EXECUCIÓ MANUAL
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Obtenir el codi (AMB PERMISOS PER FER PUSH)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Configurar Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3. Instal·lar dependències
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          # Instal·la pandas per llegir Excel si cal
          pip install pandas openpyxl

      # 4. EXECUTAR ELS TEUS SCRAPERS
      - name: Run meteo.cat scrapers and generators
        run: |
          echo "=== INICIANT PROCÉS ==="
          
          # A) Executar l'integrador principal (des de l'arrel)
          echo "Executant integrador.py..."
          python integrador.py
          
          # B) Executar el generador de banners (des de l'arrel)
          echo "Executant generador_banners.py..."
          python generador_banners.py
          
          echo "=== PROCÉS FINALITZAT ==="

      # 5. Pujar TOTS els fitxers generats/actualitzats
      - name: Commit and push all updates
        run: |
          # Configura l'usuari de Git (AQUEST ÉS EL SECRET)
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # Afegir TOTS els canvis (és la forma més segura)
          git add --all
          
          # Commit (ignora error si no hi ha canvis)
          git commit -m "Update automàtic: dades i banners [$(date -u +'%Y-%m-%d %H:%M')]" || echo "No hi ha canvis per cometre"
          
          # Push
          git push
