name: Executar Scrapers i Actualitzar Dades

on:
  # 1. DISPARAT DES DE CRON-JOB.ORG (EXTERN)
  repository_dispatch:
    types: [trigger_scrapers]
  
  # 2. EXECUCI√ì MANUAL (GITHUB UI)
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Obtenir el codi (AMB PERMISOS PER FER PUSH)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Configurar Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3. Instal¬∑lar depend√®ncies
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pandas openpyxl

      # 4. EXECUTAR ELS TEUS SCRAPERS I GENERADORS (AMB INPUT AUTOM√ÄTIC)
      - name: Run meteo.cat scrapers and generators
        run: |
          echo "=== INICIANT PROC√âS ==="
          # Assegura't que estem a l'arrel del projecte
          cd /home/runner/work/overlay-plus/overlay-plus
          
          echo "Executant SCRAPER PRINCIPAL (executor_meteo.py) amb respostes autom√†tiques..."
          # üîß L√çNIA CLAU: Passa les respostes '1', '1', 's' (i Enter) al programa
          # Aix√≤ simula que un usuari ha premut 1, Enter, 1, Enter, s, Enter.
          echo -e "1\n1\ns\n" | python executor_meteo.py
          
          echo "Executant generador de banners..."
          python generador_banners.py
          echo "=== PROC√âS FINALITZAT ==="

      # 5. PUJAR CANVIS AL REPOSITORI
      - name: Commit and push all updates
        run: |
          # A. Configurar l'usuari per al commit
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # B. Afegir tots els canvis
          git add --all
          
          # C. Crear commit (ignora si no hi ha canvis)
          git commit -m "Update autom√†tic: dades i banners [$(date -u +'%Y-%m-%d %H:%M')]" || echo "No hi ha canvis per cometre"
          
          # D. üîë FOR√áAR AUTENTICACI√ì AMB TOKEN PER AL PUSH
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/joandecorts/overlay-plus
          
          # E. Fer push
          git push
