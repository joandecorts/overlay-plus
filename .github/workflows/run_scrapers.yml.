name: Executar Scrapers i Actualitzar Dades

on:
  # 1. CRON EXTERN (VIA cron-job.org)
  # S'executa quan arriba el webhook amb l'esdeveniment 'trigger_scrapers'
  repository_dispatch:
    types: [trigger_scrapers]
  
  # 2. EXECUCI MANUAL (GITHUB UI)
  # Permet executar l'acci贸 manualment des de la pestanya "Actions" de GitHub.
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Obtenir el codi del repositori
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # 锔 S MOLT IMPORTANT afegir aquest token per poder fer push despr茅s
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Configurar Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' #  Potser cal ajustar la versi贸

      # 3. Instal路lar depend猫ncies
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          #  Afegeix aqu铆 altres comandes d'instal路laci贸 si calen

      # 4. EXECUTAR ELS TEUS SCRAPERS
      - name: Run meteo.cat scrapers
        run: |
          #  锔 AJUSTA AQUESTES RUTES!
          # Els seg眉ents s贸n exemples. Canvia els noms i l'ordre dels scripts
          # si cal treballar des d'un directori espec铆fic, fes 'cd src' abans.
          
          echo "=== INICIANT ELS SCRAPERS ==="
          # Exemple: Executar des de l'arrel del projecte
          python executor_meteo.py
          # Exemple: Executar un altre script
          python generador_banners.py
          echo "=== SCRAPERS FINALITZATS ==="

      # 5. Pujar els canvis (els nous fitxers de dades) al repositori
      - name: Commit and push updated data files
        run: |
          echo "Preparant per pujar els canvis a GitHub..."
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          #  锔 AJUSTA AQUESTES RUTES!
          # Afegeix aqu铆 la ruta exacta dels fitxers que generen els teus scripts
          # Exemple: si generen .xlsx a la carpeta 'data'
          git add src/data/*.xlsx
          # Exemple: si generen .json a la carpeta 'public'
          git add public/*.json
          # Si cal afegir tot el que hagi canviat:
          # git add --all
          
          # Fem el commit. Si no hi ha canvis, la comanda fallar suau.
          git commit -m "Automated update: data files [$(date -u +'%Y-%m-%d %H:%M')]" || echo "No hi ha canvis per cometre"
          
          # Fem el push dels canvis al repositori
          git push
