<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banner Scroll Meteorol√≤gic</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #000;
            color: white;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #1a237e;
            color: white;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 3px solid #00bcd4;
            flex-shrink: 0;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        button {
            background: #2d7fd1;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background: #3a8fe0;
        }

        #stationCounter {
            font-weight: bold;
            font-size: 16px;
            padding: 5px 10px;
            background: rgba(0,0,0,0.5);
            border-radius: 4px;
            min-width: 70px;
            text-align: center;
        }

        #viewer {
            flex: 1;
            width: 100%;
            border: none;
            background: white;
        }

        .footer {
            padding: 8px;
            background: #0a2d5e;
            text-align: center;
            font-size: 12px;
            color: #aaa;
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>üèîÔ∏è Banner Scroll Meteorol√≤gic</div>
        <div class="controls">
            <button id="prevBtn">‚óÄ Anterior</button>
            <div id="stationCounter">-/-</div>
            <button id="nextBtn">Seg√ºent ‚ñ∂</button>
            <button id="rotationBtn">‚è∏ Aturar</button>
        </div>
    </div>

    <iframe id="viewer" title="Estaci√≥ Meteorol√≤gica"></iframe>

    <div class="footer">
        Sistema de visualitzaci√≥ autom√†tica ‚Ä¢ Estacions Meteo.cat
    </div>

    <script>
        const GITHUB_BASE = 'https://joandecorts.github.io/overlay-plus/public/';
        
        let stations = [];
        let currentIndex = 0;
        let isRotating = true;
        let rotationInterval = null;
        let rotationSpeed = 30000;

        // Elements
        const viewer = document.getElementById('viewer');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const stationCounter = document.getElementById('stationCounter');
        const rotationBtn = document.getElementById('rotationBtn');

        // Funci√≥ per detectar tots els index_??.html disponibles
        async function detectStations() {
            console.log("üîç Cercant estacions a GitHub...");
            
            // Llista de totes les possibles estacions (189 IDs)
            const allPossibleStations = [
                'WB','XY','U7','WK','WG','X3','Y4','UU','DN','XX','WW','VA','WU','X6','DJ',
                'X4','D5','X8','YX','VB','W8','Z2','YT','Z1','YS','UP','Z9','X9','WX','WP',
                'YU','XU','MQ','UN','DO','MS','XC','U4','C6','W1','Z5','C8','VQ','WZ','DP',
                'UQ','VD','WJ','UH','DB','V8','CT','ZE','XL','D9','XM','UW','CE','VZ','Z7',
                'X1','KP','DI','UO','XP','VH','XJ','UI','WC','YM','WV','MV','D8','DL','WO',
                'DF','UM','XB','XA','YC','CR','KX','CD','UB','ZD','W9','VS','U9','UA','YD',
                'US','CW','VO','YJ','WI','WT','Z3','D1','C9','YE','YV','YF','XI','CG','V4',
                'WQ','WN','CY','Y5','MW','VY','DG','H1','W5','WA','YB','CJ','CC','UY','YP',
                'J5','VC','KE','MR','XG','V5','VP','UF','X5','Y7','YQ','D6','XR','XK','YA',
                'YH','VK','VU','YL','D4','XF','ZB','XV','M6','VV','WL','U3','CI','UK','U2',
                'CP','YO','CL','XS','UJ','WM','Z6','XN','XT','XH','VX','XE','C7','YK','YG',
                'Y6','DK','X7','XZ','UE','WR','XQ','UX','XD','ZC','D2','V1','D3','XO','YN',
                'UG','WS','W4','CQ','VM','YR','DQ','D7','U6'
            ];

            const foundStations = [];
            
            // Provar cada estaci√≥ (en paral¬∑lel limitat)
            const testPromises = allPossibleStations.map(async (id) => {
                const url = `${GITHUB_BASE}index_${id}.html`;
                try {
                    const response = await fetch(url, { method: 'HEAD' });
                    if (response.ok) {
                        console.log(`‚úÖ ${id} trobada`);
                        return `index_${id}.html`;
                    }
                } catch (error) {
                    // Ignorar errors
                }
                return null;
            });

            // Esperar totes les verificacions
            const results = await Promise.all(testPromises);
            
            // Filtrar les que existeixen
            stations = results.filter(station => station !== null);
            
            console.log(`üéØ ${stations.length} estacions detectades`);
            return stations;
        }

        // Carregar estaci√≥ actual
        function loadCurrentStation() {
            if (stations.length === 0) {
                viewer.srcdoc = '<html><body style="background:#000;color:white;text-align:center;padding:50px;"><h2>No hi ha estacions disponibles</h2></body></html>';
                return;
            }

            const stationFile = stations[currentIndex];
            const stationId = stationFile.replace('index_', '').replace('.html', '');
            
            console.log(`üì° Carregant: ${stationId} (${currentIndex + 1}/${stations.length})`);
            
            // Actualitzar comptador
            stationCounter.textContent = `${currentIndex + 1}/${stations.length}`;
            
            // Carregar amb timestamp per evitar cache
            const timestamp = new Date().getTime();
            const url = `${GITHUB_BASE}${stationFile}?t=${timestamp}`;
            
            // For√ßar c√†rrega
            viewer.src = url;
            
            // Verificar c√†rrega
            viewer.onload = () => {
                console.log(`‚úÖ ${stationId} carregada correctament`);
                
                // For√ßar redimensionament si cal
                setTimeout(() => {
                    try {
                        const iframeDoc = viewer.contentDocument || viewer.contentWindow.document;
                        if (iframeDoc.body) {
                            iframeDoc.body.style.width = '100%';
                            iframeDoc.body.style.height = '100%';
                            iframeDoc.body.style.margin = '0';
                            iframeDoc.body.style.padding = '0';
                        }
                    } catch (e) {
                        // CORS error - normal
                    }
                }, 100);
            };
            
            viewer.onerror = () => {
                console.log(`‚ùå Error carregant ${stationId}`);
                // No saltar autom√†ticament
            };
        }

        // Seg√ºent estaci√≥
        function nextStation() {
            if (stations.length === 0) return;
            currentIndex = (currentIndex + 1) % stations.length;
            loadCurrentStation();
        }

        // Estaci√≥ anterior
        function prevStation() {
            if (stations.length === 0) return;
            currentIndex = (currentIndex - 1 + stations.length) % stations.length;
            loadCurrentStation();
        }

        // Iniciar/aturar rotaci√≥
        function toggleRotation() {
            isRotating = !isRotating;
            
            if (isRotating) {
                rotationBtn.textContent = '‚è∏ Aturar';
                startRotation();
            } else {
                rotationBtn.textContent = '‚ñ∂ Iniciar';
                stopRotation();
            }
        }

        function startRotation() {
            stopRotation();
            rotationInterval = setInterval(nextStation, rotationSpeed);
        }

        function stopRotation() {
            if (rotationInterval) {
                clearInterval(rotationInterval);
                rotationInterval = null;
            }
        }

        // Inicialitzaci√≥
        async function init() {
            console.log("üöÄ Inicialitzant...");
            
            // Carregar estacions
            await detectStations();
            
            if (stations.length === 0) {
                viewer.srcdoc = '<html><body style="background:#000;color:white;text-align:center;padding:50px;"><h2>No s\'han trobat estacions</h2><p>Revisa la connexi√≥ o les estacions disponibles</p></body></html>';
                return;
            }
            
            // Configurar controls
            prevBtn.addEventListener('click', prevStation);
            nextBtn.addEventListener('click', nextStation);
            rotationBtn.addEventListener('click', toggleRotation);
            
            // Configurar teclat
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') prevStation();
                if (e.key === 'ArrowRight') nextStation();
                if (e.key === ' ') {
                    e.preventDefault();
                    toggleRotation();
                }
            });
            
            // Carregar primera estaci√≥
            loadCurrentStation();
            
            // Iniciar rotaci√≥ autom√†tica
            startRotation();
            
            console.log("‚úÖ Sistema preparat");
        }

        // Executar
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
